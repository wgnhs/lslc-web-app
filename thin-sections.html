<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<HTML lang="en">
   <HEAD>
      <TITLE>LSLC Thin Sections</TITLE> <link rel='icon' type='image/x-icon' href='favicon.ico'/>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
 
        <!--Google font-->
            <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
       
        <!-- Async from CDN -->    
            <script src="https://unpkg.com/async@2.4.0/dist/async.min.js"></script>
        <!-- docs: http://caolan.github.io/async/docs.html -->
       
       <!-- Load Leaflet from CDN-->
           <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
           <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet-src.js"></script>
       
       <!-- Load Esri Leaflet from CDN -->
            <script src="https://unpkg.com/esri-leaflet@2.0.7"></script>
 
       <!-- JQuery  -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
       
       <!-- JQuery UI  -->
            <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/themes/smoothness/jquery-ui.css">
            <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js"></script>
 
       
       <!-- local stylesheets -->
           <LINK href="generalStyle.css" rel='stylesheet'/>
           <LINK href="modalStyle.css" rel='stylesheet'/>

       
      <!-- Enable media queries for old IE -->
      <!--[if lt IE 9]>
        <script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
      <![endif]-->
       
        <!-- Google analytics: place in the head tag after other script links -->
       <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-50757423-2', 'auto');
          ga('send', 'pageview');

       </script>
       
       <style>
           /* title at the top of the page. inline with the span that states the number of thin sections. */
           h2 {
               display: inline;
               padding-right: 5px;
           }
           .colortext{
               color:  #b74226;
           }
           
           /* galleryItemDiv is a container, and each row of them occupies 100% of the parent width. */
            .galleryItemDiv {
               display: inline-block;
            }
            .galleryItemDiv:hover{
               background-color: #e6e6e6;
               cursor: pointer;
            }
           /* thinSection is the inner container within each galleryItemDiv -- contains the thin section pictures and text. */
           .thinSection {
               margin: 3px;
           }
           .galleryItemDiv p{
               margin: 0;
           }
           .galleryThumb { 
               width: 50%; /* half the width of the .thinSection container */
           }
          
           /* PAGINATION / NAV */
           #navContainer {
               text-align: center;
               background-color: #e6e6e6; /* bar all the way across the page */
           }
           .galleryNav {
               /*background-color: #e6e6e6;*/ /* just color between the next and previous buttons */
               display: inline-block;
           }
           .galleryNav > label, .galleryNav>span {
               margin: 0px 5px;
           }
           .galleryNav input{
               display: inline-block;
               text-align: center;
               width: 4em;
           }
           .galleryNav .button{
               background-color:  #b74226;
               display: inline-block;
               padding: 2px 10px;
               color: white;
           }
           .galleryNav .button:hover{
               background-color:  #842d1a;
               cursor: pointer;
           }
           
           /* Responsiveness */
           @media only screen and (max-width : 550px) {
               .galleryItemDiv {
                   width: 100%;
               }
           }
           @media only screen and (min-width : 551px) and (max-width : 1100px) {
               .galleryItemDiv {
                   width: 50%;
               }
           }
            @media only screen and (min-width : 1101px) and (max-width : 1900px) {
               .galleryItemDiv {
                   width: 33%;
               }
           }
           @media only screen and (min-width : 1901px) and (max-width : 2900px) {
               .galleryItemDiv {
                   width: 25%;
               }
           }
           @media only screen and (min-width : 2901px) {
               .galleryItemDiv {
                   width: 20%;
               }
           }
           
       </style>
       
</HEAD>
<BODY>
  
   <div id="header"></div>
   <div id="wrapper" class="wrapper-shadow">
        <div id="modalBackground" class="modalBackground">
           <div id="modal-content"></div>
       </div> 

       <h2 id="galleryTitle">Thin Section Gallery</h2> 
       <p>Thin sections are pieces of rock, sliced and ground thin and mounted on microscope slides. Each thin section in our collection was photographed in plane-polarized light (background appears white) and cross-polarized light (background appears dark blue or black), as geologists in 1900 would have viewed these under a microscope. In cross-polarized light, some minerals appear in bright hues called interference colors due to their property of <a href="https://en.wikipedia.org/wiki/Refractive_index#Birefringence" target="_blank">birefringence</a>.<br><br>Click on a thin section photo pair below to view it in detail. </p>
       <div id="navContainer">
           <div class="galleryNav">
               <div id="galleryPrevTop" class='button' role="button">&laquo;</div>
               <label for="galleryPageTop">page </label>
               <input id="galleryPageTop" name="galleryPageTop" type="search" value="1">
               <div id="galleryNextTop" class='button' role="button">&raquo;</div>
           </div>
       </div>

       <div id="thinGallery" class="divisionContent"></div>
       
       <div id="navContainer">
           <div class="galleryNav">
               <div id="galleryPrevBottom" class='button' role="button">&laquo;</div>
               <label for="galleryPageBottom">page </label>
               <input id="galleryPageBottom" name="galleryPageBottom" type="search" value="1">
               <div id="galleryNextBottom" class='button' role="button">&raquo;</div>
           </div>
       </div>

   
       <div id="footer"></div>
   </div><!--end wrapper div-->
   
   <!-- header js: must go after the wrapper div and header div -->
   <script src="header.js"></script>

    
    <!-- javascript links -->
    <script src="mapServiceUrls.js"></script>
    <script src="modal.js"></script>
    
    <!-- javascript for building the thin section gallery -->
    <script>

        //global variables: 
        var globalThinSectionGalleryArray = []; 
        var pageSize = 24; //the number of image pairs to show on each page of the gallery. 
        var currentPage = 1; //this gets reset by the buildGallery function.
        
         //happens right away on page load: 
        async.series([retrieveThinSections, callSort, callBuild, initGallery], function(){
            console.log("all done. global data array: ", globalThinSectionGalleryArray);
        });
        
        function initGallery (){
            
            //delegated click listener for launching the modal: 
            $("#thinGallery").on('click','.thinSection', function(){
                console.log("view modal for thin section #", $(this).data('thinID'));
                
                modal.thinSectionViewer($(this).data('thinSectionNumber'), $(this).data('handSampleNumber'));
            });
              
        }
        
        /* Module for thin sections data */
        var thinSectionsManager = (function(){
            
            var add = function(array){
                //construct the image URL properties from the thin section number. 
                array.PPLthumbURL = 'https://data.wgnhs.wisc.edu/lake-superior-legacy/assets/thin-section-thumbs/'+array[thinSectionNumberField]+'ppl_thumb.jpg'; 
                array.XPLthumbURL = 'https://data.wgnhs.wisc.edu/lake-superior-legacy/assets/thin-section-thumbs/'+array[thinSectionNumberField]+'xpl_thumb.jpg'; 
                globalThinSectionGalleryArray = globalThinSectionGalleryArray.concat(array);
                
            }
            
            
            var sortByNumber = function(attr, direction){
                               
                console.log("sort by "+attr+" in "+direction+" order."); 
                
                if (direction === 'ascending'){
                
                    globalThinSectionGalleryArray.sort(function (a,b){

                        if(parseInt(a[attr]) < parseInt(b[attr])) return -1; 
                        if(parseInt(a[attr]) > parseInt(b[attr])) return 1; 
                        return 0;

                    });
                } else if (direction === 'descending'){
                    globalThinSectionGalleryArray.sort(function (a,b){

                        if(parseInt(a[attr]) > parseInt(b[attr])) return -1; 
                        if(parseInt(a[attr]) < parseInt(b[attr])) return 1; 
                        return 0;

                    });
                }
                
                console.log(globalThinSectionGalleryArray);
            }
            
            var page = function(pageNumber, pageSize){
                
                //page number arguments start at page 1,so we need to correct for zero-indexing
                var start = (pageNumber-1) * pageSize; 
                var end = start + pageSize;
                return globalThinSectionGalleryArray.slice(start,end);
                
            }
            
            //exposed methods: 
            return {
                "add": add, 
                "sortByNumber": sortByNumber,
                "page": page,
            }
        })(); //end thinSectionManager
        
        //take in the URL hash string and extract just the part after the # but before a ?
       function extractIdFromHash(str){
           console.log("extract the id from ", str);
           
           //first, strip the first # by replacing it with an empty string. 
           var nohash = str.replace("#", "");  
           
           //then split the string into two parts at the first question mark and return the first part.
           var identifier = nohash.split('?')[0]; 
           
           return identifier
       }
    
       function retrieveThinSections(callback){
           //this should happen once upon page load. 
           
           var thinImagesQuery = L.esri.query({url: thinSectionsTableURL});
           thinImagesQuery.where(thinSectionPhotosField+"= 1");
           thinImagesQuery.fields(["*"]); 
           
           //easter egg: using #color at the end of the URL will select only the subset of the thin section images listed below.
           if(extractIdFromHash(window.location.hash) == 'color'){
               console.log("colorful images only.");
               //add a note in the title of the page
               $("#galleryTitle").append("<strong class='colortext'> #color</strong>");
               
               //array of thin section numbers with colorful images. The gallery will always appear in number order, regardless of the order of numbers in this list. I am keeping this list in numerical order to prevent entering duplicates.
               var colorfulImages = ["'23'", "'144'", "'148'", "'170'", "'193'", "'197'",  "'199'", "'200'", "'267'", "'321'", "'406'", "'408'", "'462'", "'463'", "'724'", "'731'", "'750'", "'754'", "'755'", "'757'", "'758'", "'776'", "'809'", "'831'", "'835'", "'836'", "'840'", "'959'", "'967'", "'1009'", "'1019'", "'1020'", "'1021'", "'1023'", "'1025'", "'1030'", "'1111'", "'1126'", "'1127'", "'1183'", "'1184'", "'1188'", "'1197'", "'1204'", "'1237'", "'1239'", "'1240'", "'1242'", "'1244'", "'1299'", "'1382'", "'1408'", "'1409'", "'1439'", "'1443'", "'1446'", "'1452'", "'1453'", "'1457'", "'1583'", "'1598'", "'1606'", "'1619'", "'1798'", "'1839'", "'1954'", "'2068'", "'2075'", "'2089'", "'2107'", "'2148'", "'2149'", "'2494'", "'2647'", "'2655'", "'2719'", "'2840'", "'2879'", "'2905'", "'2980'", "'3353'", "'3387'", "'3398'", "'3528'", "'3533'", "'3745'", "'3843'", "'3845'", "'3850'", "'3856'", "'3903'", "'4063'", "'4088'", "'4105'", "'4207'", "'4242'", "'4259'", "'4350'", "'4366'", "'4369'", "'4373'", "'4419'", "'4538'", "'4559'", "'4560'", "'4561'", "'4565'", "'4596'", "'4599'", "'4600'", "'4601'", "'4602'", "'4608'", "'4692'", "'4783'", "'4790'", "'4810'", "'4815'", "'4820'", "'4823'", "'4861'", "'4862'", "'4863'", "'4875'", "'4880'", "'4906'", "'4907'", "'4940'", "'4949'", "'4952'", "'4953'", "'4959'", "'4964'", "'4965'", "'4966'", "'4972'", "'4973'", "'4975'", "'4976'", "'4986'", "'5039'", "'5068'", "'5069'", "'5071'", "'5332'", "'5446'", "'5566'", "'5682'", "'5705'", "'5706'", "'5845'", "'5873'", "'5874'", "'5992'", "'6026'", "'6088'", "'6090'", "'6098'", "'6591'", "'6880'", "'7049'", "'7050'", "'7052'", "'7079'", "'7146'", "'7147'", "'7156'", "'7157'", "'7174'", "'7176'", "'7304'", "'7340'", "'7392'", "'7501'", "'7504'", "'7543'", "'7559'", "'7566'", "'7567'", "'7571'", "'7577'", "'7581'", "'7583'", "'7589'", "'7605'", "'7654'", "'7688'", "'7729'", "'7769'", "'7770'", "'7774'", "'7778'", "'7792'", "'7805'", "'7935'", "'7942'", "'8032'", "'8054'", "'8190'", "'8300'", "'8312'", "'8313'", "'8331'", "'8350'", "'8369'", "'8373'", "'8498'", "'8661'", "'8662'", "'8664'", "'8667'", "'8671'", "'8680'", "'8693'", "'8699'", "'8702'", "'8721'", "'8722'", "'8730'", "'8735'", "'8749'", "'8752'", "'8753'", "'8757'", "'8871'", "'8878'", "'8908'", "'8932'", "'8955'", "'9000'", "'9038'", "'9060'", "'9065'", "'9093'", "'9153'", "'9200'", "'9268'", "'9278'", "'9325'", "'9357'", "'9400'", "'9401'", "'9521'", "'9528'", "'9530'", "'9545'", "'9551'", "'9604'", "'9610'", "'9611'", "'9630'", "'9632'", "'9633'", "'9639'", "'9650'", "'9706'", "'9707'", "'9709'", "'9726'", "'9737'", "'9740'", "'9785'", "'9807'", "'9857'", "'9878'", "'9900'", "'10120'", "'10235'", "'10237'", "'10264'", "'10305'", "'10326'", "'10415'", "'10416'", "'10442'", "'10452'", "'10463'", "'10519'", "'10821'", "'10841'", "'10992'", "'11000'", "'11193'", "'11234'", "'11692'", "'12119'", "'12475'", "'12815'", "'12907'", "'13482'", "'13899'", "'14345'", "'14447'", "'14542'", "'14616'", "'14684'", "'14706'", "'14795'", "'14846'", "'14847'", "'14848'", "'14853'", "'14857'", "'14859'", "'14889'", "'15173'", "'15182'", "'15263'", "'15439'", "'15443'", "'15482'", "'15484'", "'15501'", "'15570'", "'15623'",  "'15624'", "'15626'", "'15634'", "'15820'", "'15840'", "'15841'", "'15871'", "'15885'", "'16025'", "'16027'", "'16037'", "'16043'", "'16044'", "'16069'", "'16083'", "'16093'", "'16142'", "'16148'", "'16158'", "'16175'", "'16253'", "'16255'", "'16282'", "'16350'", "'16351'", "'16355'", "'16356'", "'16364'", "'16366'", "'16372'", "'16842'", "'16919'", "'16960'", "'17101'", "'17152'", "'17208'", "'17233'", "'17236'", "'17446'", "'17450'", "'17454'"];
               
               //reset the where query to only select thin sections in the list above. 
               thinImagesQuery.where(thinSectionNumberField+" IN ("+colorfulImages+")");
           }
           
           thinImagesQuery.run(function(err, featureCollection, response){
               
               //I think Pete changed the map server so we can get over 15000 results in one query. 
               
               buildGalleryNav(response.features.length, pageSize); 
               
               for (i in response.features){ 
                   
                  thinSectionsManager.add(response.features[i].attributes);
               }
               callback();
               
           }); //end query.run callback

       } //end retrieveThinSections
        
        function buildGalleryNav (resultsTotal, pageSize) {
            //should be called once on page initialization. 
             var numberOfPages = Math.ceil(resultsTotal/pageSize); 
            
            $("#galleryTitle").after("<span>("+resultsTotal+" found)</span>");
            $("#galleryPageTop").after("<span> of "+numberOfPages+"</span>");
            $("#galleryPageBottom").after("<span> of "+numberOfPages+"</span>");

            console.log("build a page nav for ", resultsTotal, "results.", numberOfPages, "pages."); 
            
            
            //input listener for page number input: 
            $("#galleryPageTop").on("input", function(){
                var newPage = $("#galleryPageTop").val();
                
                console.log("change to page", newPage);
                buildThinGallery(newPage, pageSize);
                
            });
            $("#galleryPageBottom").on("input", function(){
                var newPage = $("#galleryPageBottom").val();
                
                console.log("change to page", newPage);
                buildThinGallery(newPage, pageSize);
                
            });
            
            
            //input listener for next and previous buttons: 
            $("#galleryNextTop").click(function(){
                var newPage = parseInt(currentPage)+1;
                buildThinGallery(newPage, pageSize);
            });
            
            $("#galleryNextBottom").click(function(){
                var newPage = parseInt(currentPage)+1;
                 buildThinGallery(newPage, pageSize);
            });
            
            $("#galleryPrevTop").click(function(){
                var newPage = parseInt(currentPage)-1;
                buildThinGallery(newPage, pageSize);
            });
            
            $("#galleryPrevBottom").click(function(){
                var newPage = parseInt(currentPage)-1;
                buildThinGallery(newPage, pageSize);
            });

        }
        
        function buildThinGallery(pageNumber, pageSize) {
            //called every time a new page is displayed
            
            //reset the global var representing the current page: 
            currentPage = pageNumber;
            //change the page input value: 
            $("#galleryPageTop").val(currentPage);
            $("#galleryPageBottom").val(currentPage);
            
            //reset the variable representing the contents of the gallery. 
            var galleryContent= $("<div></div>");
            
            var dataForDisplay = thinSectionsManager.page(pageNumber, pageSize); // .page accepts two arguments: page number then page size
            
            
            //for every thin section, create the html element
            for (i in dataForDisplay){
                var item = dataForDisplay[i];
                var galleryItem  = $('<div class="galleryItemDiv"></div>');
                var thinSec = $('<div class="thinSection"></div>').html("<p>Thin Section #"+item[thinSectionNumberField]+"</p>");
                
                thinSec.append("<img class='galleryThumb' src='"+item.PPLthumbURL+"' alt='thin section photo in plane-polarized light'>");
                thinSec.append("<img class='galleryThumb' src='"+item.XPLthumbURL+"' alt='thin section photo in cross-polarized light'>");
               
                thinSec.attr('title','click to view');

                thinSec.data({"thinSectionNumber": item[thinSectionNumberField], "handSampleNumber": item[handSampleNumberField]});
                
                galleryItem.append(thinSec);
                
                galleryContent.append(galleryItem);  
                
            }
            
            //replace the contents of the gallery div with the updated content variable. 
            $("#thinGallery").html(galleryContent);
      
        }
        
        function callBuild(callback){
            buildThinGallery(1,pageSize); 
            callback();
        }
        
        function callSort(callback){
            thinSectionsManager.sortByNumber(thinSectionNumberField, "ascending"); 
            callback();
        }
        
       
    </script><!-- end javascript for building the thin section gallery -->
   
   
</BODY> 
</HTML>
